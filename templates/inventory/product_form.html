{% extends "base.html" %}

{% block title %}
    {% if edit_mode %}Edit Product{% else %}Add Product{% endif %} - Inventory Management
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <!-- Header -->
    <div style="margin-bottom: 2rem; text-align: center;">
        <h1 style="margin: 0; color: var(--text-primary);">
            {% if edit_mode %}
                ‚úèÔ∏è Edit Product
            {% else %}
                ‚ûï Add New Product
            {% endif %}
        </h1>
        {% if edit_mode and product %}
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">
                Editing: {{ product.name }}
            </p>
        {% endif %}
    </div>

    <!-- Form -->
    <div class="card">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="productForm">
                <!-- Hidden product type field -->
                <input type="hidden" name="product_type" value="{{ product_type|default('power_tools') }}">

                <!-- Product Name -->
                <div class="form-group">
                    <label for="name" class="form-label">Product Name *</label>
                    <input type="text"
                           id="name"
                           name="name"
                           class="form-input"
                           value="{{ product.name if edit_mode and product else '' }}"
                           required
                           placeholder="Enter product name"
                           maxlength="255">
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description" class="form-label">Description</label>
                    <textarea id="description"
                              name="description"
                              class="form-input form-textarea"
                              placeholder="Enter product description (optional)"
                              rows="4">{{ product.description if edit_mode and product else '' }}</textarea>
                </div>

                <!-- Quantity (only for power_tools) -->
                {% if product_type|default('power_tools') == 'power_tools' %}
                <div class="form-group">
                    <label for="quantity" class="form-label">Stock Quantity *</label>
                    <input type="number"
                           id="quantity"
                           name="quantity"
                           class="form-input"
                           min="0"
                           step="1"
                           value="{{ product.quantity if edit_mode and product else '0' }}"
                           required
                           placeholder="Enter stock quantity">
                    <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                        Number of units in stock
                    </small>
                </div>
                {% endif %}

                <!-- Tiles-specific fields -->
                {% if product_type == 'tiles' %}
                <div class="form-group">
                    <label class="form-label">Box Information</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label for="tiles_per_box" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Tiles per Box
                            </label>
                            <input type="number"
                                   id="tiles_per_box"
                                   name="tiles_per_box"
                                   class="form-input"
                                   min="0"
                                   step="1"
                                   value="{{ product.tile_details.tiles_per_box if edit_mode and product and product.tile_details else '' }}"
                                   placeholder="0">
                        </div>
                        <div>
                            <label for="number_of_boxes" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Number of Boxes
                            </label>
                            <input type="number"
                                   id="number_of_boxes"
                                   name="number_of_boxes"
                                   class="form-input"
                                   min="0"
                                   step="1"
                                   value="{{ product.tile_details.number_of_boxes if edit_mode and product and product.tile_details else '' }}"
                                   placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tile Dimensions</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label for="dimension_length" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Length
                            </label>
                            <input type="number"
                                   id="dimension_length"
                                   name="dimension_length"
                                   class="form-input"
                                   step="0.01"
                                   min="0"
                                   value="{{ product.tile_details.dimension_length if edit_mode and product and product.tile_details else '' }}"
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label for="dimension_width" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Width
                            </label>
                            <input type="number"
                                   id="dimension_width"
                                   name="dimension_width"
                                   class="form-input"
                                   step="0.01"
                                   min="0"
                                   value="{{ product.tile_details.dimension_width if edit_mode and product and product.tile_details else '' }}"
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label for="dimension_unit" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Unit
                            </label>
                            <select id="dimension_unit"
                                    name="dimension_unit"
                                    class="form-input">
                                <option value="feet" {% if edit_mode and product and product.tile_details and product.tile_details.dimension_unit == 'feet' %}selected{% endif %}>Feet</option>
                                <option value="inch" {% if edit_mode and product and product.tile_details and product.tile_details.dimension_unit == 'inch' %}selected{% endif %}>Inch</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sq_feet_per_box" class="form-label">Sq Feet per Box</label>
                    <input type="number"
                           id="sq_feet_per_box"
                           name="sq_feet_per_box"
                           class="form-input"
                           step="0.01"
                           min="0"
                           value="{{ product.tile_details.sq_feet_per_box if edit_mode and product and product.tile_details else '' }}"
                           placeholder="0.00">
                    <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                        Total square footage covered per box
                    </small>
                </div>
                {% endif %}

                <!-- Pricing Section -->
                <div class="form-group">
                    <label class="form-label">Pricing Information</label>
                    <div class="grid grid-cols-1" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Buying Price -->
                        <div>
                            <label for="buying_price" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Buying Price (‚Çπ)
                            </label>
                            <input type="number"
                                   id="buying_price"
                                   name="buying_price"
                                   class="form-input"
                                   step="0.01"
                                   min="0"
                                   value="{{ product.pricing.buying_price if edit_mode and product and product.pricing else '' }}"
                                   placeholder="0.00">
                        </div>

                        <!-- Selling Price -->
                        <div>
                            <label for="selling_price" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                Selling Price (‚Çπ)
                            </label>
                            <input type="number"
                                   id="selling_price"
                                   name="selling_price"
                                   class="form-input"
                                   step="0.01"
                                   min="0"
                                   value="{{ product.pricing.selling_price if edit_mode and product and product.pricing else '' }}"
                                   placeholder="0.00">
                        </div>

                        <!-- MRP (only for power_tools) -->
                        {% if product_type|default('power_tools') == 'power_tools' %}
                        <div>
                            <label for="mrp" class="form-label" style="font-size: 0.875rem; color: var(--text-secondary);">
                                MRP (‚Çπ)
                            </label>
                            <input type="number"
                                   id="mrp"
                                   name="mrp"
                                   class="form-input"
                                   step="0.01"
                                   min="0"
                                   value="{{ product.pricing.mrp if edit_mode and product and product.pricing else '' }}"
                                   placeholder="0.00">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Image Upload (only for new products) -->
                {% if not edit_mode %}
                <div class="form-group">
                    <label for="images" class="form-label">Product Images</label>
                    <input type="file"
                           id="images"
                           name="images"
                           class="form-input"
                           multiple
                           accept="image/*"
                           style="padding: 0.5rem;">
                    <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                        Select multiple images (JPG, PNG, GIF, WebP). Max 16MB per file.
                    </small>

                    <!-- Image Preview -->
                    <div id="imagePreview" class="image-preview" style="margin-top: 1rem; display: none;">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Selected images:
                        </div>
                        <div id="previewContainer" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                    </div>
                </div>
                {% endif %}

                <!-- Existing Images (for edit mode) -->
                {% if edit_mode and product and product.images %}
                <div class="form-group">
                    <label class="form-label">Current Images</label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        {% for image in product.images %}
                            <div style="position: relative; border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden;">
                                <img src="{{ url_for('inventory.uploaded_file', filename='user_' + product.user_id|string + '/' + image.filename) }}"
                                     alt="{{ image.original_name }}"
                                     style="width: 100px; height: 100px; object-fit: cover;">
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem; font-size: 0.75rem; text-align: center;">
                                    {{ image.original_name[:10] }}...
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                        To add or remove images, please create a new product or contact support.
                    </small>
                </div>
                {% endif %}

                <!-- Form Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-outline">
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        {% if edit_mode %}
                            üíæ Update Product
                        {% else %}
                            ‚ûï Create Product
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .image-preview img {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    @media (max-width: 768px) {
        .grid.grid-cols-1 {
            grid-template-columns: 1fr;
        }

        .form-group > div {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus on name field
    document.getElementById('name').focus();

    // Image preview functionality
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');

    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);

            if (files.length > 0) {
                imagePreview.style.display = 'block';
                previewContainer.innerHTML = '';

                files.forEach(function(file) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.cssText = 'max-width: 100px; max-height: 100px; object-fit: cover; border-radius: var(--border-radius); border: 1px solid var(--border-color);';
                            previewContainer.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                imagePreview.style.display = 'none';
            }
        });
    }

    // Form validation
    const form = document.getElementById('productForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();

        if (!name) {
            e.preventDefault();
            alert('Product name is required.');
            document.getElementById('name').focus();
            return;
        }

        // Disable submit button to prevent double submission
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Processing...';

        // Re-enable button after 5 seconds as fallback
        setTimeout(function() {
            submitBtn.disabled = false;
            submitBtn.textContent = '{% if edit_mode %}üíæ Update Product{% else %}‚ûï Create Product{% endif %}';
        }, 5000);
    });

    // Price validation
    const priceInputs = ['buying_price', 'selling_price', 'mrp'];
    priceInputs.forEach(function(inputId) {
        const input = document.getElementById(inputId);
        input.addEventListener('input', function(e) {
            const value = parseFloat(e.target.value);
            if (value < 0) {
                e.target.value = 0;
            }
        });
    });
});
</script>
{% endblock %}