{% extends "base.html" %}

{% block title %}Dashboard - Inventory Management{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 style="margin: 0; color: var(--text-primary);">üì¶ Your Inventory</h1>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">
                {% if total_products > 0 %}
                    {{ total_products }} product{{ 's' if total_products != 1 else '' }} total
                {% else %}
                    No products yet - add your first one!
                {% endif %}
            </p>
        </div>
        <a href="{{ url_for('inventory.new_product', type=product_type|default('power_tools')) }}" class="btn btn-primary">
            ‚ûï Add Product
        </a>
    </div>
</div>

<!-- Product Type Tabs -->
<div style="margin-bottom: 2rem;">
    <div style="border-bottom: 2px solid #e2e8f0; display: flex; gap: 1rem;">
        <a href="{{ url_for('inventory.dashboard', type='power_tools') }}"
           style="padding: 1rem 2rem; text-decoration: none; font-weight: 600;
                  {% if product_type|default('power_tools') == 'power_tools' %}
                  border-bottom: 3px solid #3b82f6; color: #3b82f6;
                  {% else %}
                  color: #64748b;
                  {% endif %}">
            üîß Power Tools & Others
        </a>
        <a href="{{ url_for('inventory.dashboard', type='tiles') }}"
           style="padding: 1rem 2rem; text-decoration: none; font-weight: 600;
                  {% if product_type == 'tiles' %}
                  border-bottom: 3px solid #3b82f6; color: #3b82f6;
                  {% else %}
                  color: #64748b;
                  {% endif %}">
            üî≤ Tiles
        </a>
    </div>
</div>

<!-- Search Bar -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        <form method="GET" style="display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1;">
                <input type="text"
                       name="search"
                       class="form-input"
                       value="{{ search_term }}"
                       placeholder="üîç Search products by name or description..."
                       style="margin: 0;">
            </div>
            <button type="submit" class="btn btn-outline">Search</button>
            {% if search_term %}
                <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-secondary">Clear</a>
            {% endif %}
        </form>
    </div>
</div>

<!-- Products Grid -->
{% if products %}
    <div class="grid grid-cols-1" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
        {% for product in products %}
            <div class="card product-card" style="transition: var(--transition);">
                <!-- Product Image -->
                <div class="product-image" style="height: 200px; background-color: var(--background-color); position: relative; overflow: hidden;">
                    {% if product.images and product.images|length > 0 %}
                        <img src="{{ url_for('inventory.uploaded_file', filename='user_' + product.user_id|string + '/' + product.images[0].filename) }}"
                             alt="{{ product.name }}"
                             style="width: 100%; height: 100%; object-fit: cover;">
                        {% if product.images|length > 1 %}
                            <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.75rem;">
                                +{{ product.images|length - 1 }} more
                            </div>
                        {% endif %}
                    {% else %}
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); font-size: 3rem;">
                            üì¶
                        </div>
                    {% endif %}
                </div>

                <!-- Product Info -->
                <div class="card-body">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem;">
                        <a href="{{ url_for('inventory.view_product', product_id=product.id) }}"
                           style="color: var(--text-primary); text-decoration: none;">
                            {{ product.name }}
                        </a>
                    </h3>

                    {% if product.description %}
                        <p style="color: var(--text-secondary); margin: 0 0 1rem 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ product.description }}
                        </p>
                    {% endif %}

                    <!-- Pricing -->
                    {% if product.pricing %}
                        <div class="pricing-info" style="margin-bottom: 1rem;">
                            {% if product.pricing.selling_price %}
                                <div style="font-size: 1.125rem; font-weight: bold; color: var(--success-color);">
                                    {{ product.pricing.selling_price|currency }}
                                </div>
                            {% endif %}
                            <div style="display: flex; gap: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                                {% if product.pricing.buying_price %}
                                    <span>Cost: {{ product.pricing.buying_price|currency }}</span>
                                {% endif %}
                                {% if product.pricing.mrp and product.product_type == 'power_tools' %}
                                    <span>MRP: {{ product.pricing.mrp|currency }}</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Quantity Display (for power_tools only) -->
                    {% if product.product_type == 'power_tools' and product.quantity is defined %}
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background-color: {% if product.quantity > 10 %}#f0fdf4{% elif product.quantity > 0 %}#fffbeb{% else %}#fef2f2{% endif %}; border-radius: var(--border-radius); text-align: center;">
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Stock</div>
                            <div style="font-weight: bold; color: {% if product.quantity > 10 %}var(--success-color){% elif product.quantity > 0 %}var(--warning-color){% else %}var(--error-color){% endif %};">
                                {{ product.quantity }} units
                                {% if product.quantity == 0 %}
                                    <div style="font-size: 0.75rem;">(Out of Stock)</div>
                                {% elif product.quantity <= 10 %}
                                    <div style="font-size: 0.75rem;">(Low Stock)</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Tile Details Summary (for tiles only) -->
                    {% if product.product_type == 'tiles' and product.tile_details %}
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background-color: #f0f9ff; border-radius: var(--border-radius); text-align: center;">
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Boxes Available</div>
                            <div style="font-weight: bold; color: var(--primary-color);">
                                {{ product.tile_details.number_of_boxes or 0 }} boxes
                                {% if product.tile_details.dimension_display %}
                                    <div style="font-size: 0.75rem;">({{ product.tile_details.dimension_display }})</div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Creator/Updater Info (Collaborative Mode) -->
                    <div class="product-meta" style="font-size: 0.75rem; color: var(--text-secondary); padding-top: 0.75rem; border-top: 1px solid var(--border-color); margin-bottom: 1rem;">
                        {% if product.creator_email %}
                        <div class="product-meta-item" title="Created by">
                            <span>üë§</span>
                            <span>{{ product.creator_email.split('@')[0] }}</span>
                        </div>
                        {% endif %}
                        {% if product.updater_email and product.updater_email != product.creator_email %}
                        <div class="product-meta-item" title="Last updated by">
                            <span>‚úèÔ∏è</span>
                            <span>{{ product.updater_email.split('@')[0] }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 0.5rem; justify-content: space-between;">
                        <a href="{{ url_for('inventory.view_product', product_id=product.id) }}"
                           class="btn btn-outline" style="flex: 1; text-align: center; font-size: 0.875rem;">
                            üëÅÔ∏è View
                        </a>
                        <a href="{{ url_for('inventory.edit_product', product_id=product.id) }}"
                           class="btn btn-secondary" style="flex: 1; text-align: center; font-size: 0.875rem;">
                            ‚úèÔ∏è Edit
                        </a>
                        <button onclick="confirmDelete({{ product.id }}, '{{ product.name }}')"
                               class="btn btn-danger" style="flex: 1; font-size: 0.875rem;">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>

                <!-- Product Footer -->
                <div class="card-footer" style="font-size: 0.75rem; color: var(--text-secondary);">
                    Created: {{ product.created_at|datetime('%b %d, %Y') }}
                    {% if product.updated_at != product.created_at %}
                        ‚Ä¢ Updated: {{ product.updated_at|datetime('%b %d, %Y') }}
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
        <div class="pagination" style="margin-top: 2rem; text-align: center;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                {% if has_prev %}
                    <a href="{{ url_for('inventory.dashboard', page=current_page-1, search=search_term, type=product_type|default('power_tools')) }}"
                       class="btn btn-outline">‚Üê Previous</a>
                {% endif %}

                <span style="padding: 0.75rem 1rem; color: var(--text-secondary);">
                    Page {{ current_page }} of {{ total_pages }}
                </span>

                {% if has_next %}
                    <a href="{{ url_for('inventory.dashboard', page=current_page+1, search=search_term, type=product_type|default('power_tools')) }}"
                       class="btn btn-outline">Next ‚Üí</a>
                {% endif %}
            </div>
        </div>
    {% endif %}

{% else %}
    <!-- Empty State -->
    <div class="empty-state" style="text-align: center; padding: 4rem 2rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üì¶</div>
        {% if search_term %}
            <h2 style="color: var(--text-secondary); margin-bottom: 1rem;">No products found</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                No products match your search for "{{ search_term }}". Try a different search term.
            </p>
            <a href="{{ url_for('inventory.dashboard') }}" class="btn btn-primary">
                Clear Search
            </a>
        {% else %}
            <h2 style="color: var(--text-secondary); margin-bottom: 1rem;">Your inventory is empty</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                Start building your inventory by adding your first product.
            </p>
            <a href="{{ url_for('inventory.new_product') }}" class="btn btn-primary">
                ‚ûï Add Your First Product
            </a>
        {% endif %}
    </div>
{% endif %}

<!-- Hidden Delete Form -->
<form id="deleteForm" method="POST" style="display: none;">
</form>
{% endblock %}

{% block extra_css %}
<style>
    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .product-image img {
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-image img {
        transform: scale(1.05);
    }

    @media (max-width: 768px) {
        .dashboard-header > div {
            flex-direction: column;
            align-items: stretch;
        }

        .dashboard-header h1 {
            text-align: center;
        }

        .card-body form {
            flex-direction: column;
        }

        .card-body form .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(productId, productName) {
    if (confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone.`)) {
        const form = document.getElementById('deleteForm');
        form.action = `/inventory/product/${productId}/delete`;
        form.submit();
    }
}
</script>
{% endblock %}